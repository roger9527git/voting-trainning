events {}

http {
  resolver 127.0.0.11 valid=10s;

  # ===== Access Log（可追 upstream / latency）=====
  log_format upstream_log
    '$remote_addr - $host [$time_local] '
    '"$request" $status '
    'req_time=$request_time '
    'upstream_addr=$upstream_addr '
    'upstream_status=$upstream_status '
    'upstream_time=$upstream_response_time';

  # ===== Upstreams（後端池）=====
  upstream vote_upstream {
    server vote:80  max_fails=3 fail_timeout=10s;
    server vote2:80 max_fails=3 fail_timeout=10s;
    keepalive 32;
  }

  upstream result_upstream {
    server result:80  max_fails=3 fail_timeout=10s;
    server result2:80 max_fails=3 fail_timeout=10s;
    keepalive 32;
  }

  # =================================================
  # HTTP (80): 只做轉址到 HTTPS
  # =================================================
  server {
    listen 80;
    return 301 https://$host$request_uri;
  }

  # =================================================
  # HTTPS (443): TLS termination + reverse proxy
  # =================================================
  server {
    listen 443 ssl;

    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # （可選加分）TLS 基本設定
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # （可選加分）HSTS（自簽環境也可開，但若你會切回 HTTP 測試可先註解）
    add_header Strict-Transport-Security "max-age=31536000" always;

    # ===== 套用強化版 access log =====
    access_log /var/log/nginx/access.log upstream_log;

    # vote
    location / {
      proxy_connect_timeout 3s;
      proxy_read_timeout    5s;
      proxy_send_timeout    5s;

      proxy_pass http://vote_upstream;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    }

    # result（保留你的 /result/ 路徑）
    location /result/ {
      proxy_connect_timeout 3s;
      proxy_read_timeout    5s;
      proxy_send_timeout    5s;

      proxy_pass http://result_upstream/;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    }
  }
}
